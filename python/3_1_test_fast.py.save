import time
import os
import sys
import pandas as pd
import numpy as np
import json
import joblib

sys.path.append("..")

# 1. IMPORT PACKAGE
try:
    import automl
    print("‚úÖ Package 'automl' import√©.")
except ImportError:
    print("‚ùå ERREUR : Package 'automl' introuvable.")
    exit(1)

# =============================================================================
# 1. INITIALISATION
# =============================================================================
print("‚è≥ Initialisation du Pipeline...")
t_init = time.time()

BASE_DIR = ""
DATA_DIR      = BASE_DIR + "data/"
GENERATED_DIR = BASE_DIR + "generated_files/pkl/"

MODEL_KNN     = GENERATED_DIR + "model_knn.pkl"
VECT_KNN      = GENERATED_DIR + "vectorizer_knn.pkl"
METADATA      = GENERATED_DIR + "wines_metadata.pkl"
COLORS_FILE   = DATA_DIR      + "wine_colors.json"
GROUPS_FILE   = GENERATED_DIR + "keyword_groups.pkl"
COLUMNS_FILE  = GENERATED_DIR + "keywords_list.pkl"

try:
    # Chargement ressources
    if os.path.exists(MODEL_KNN):
        knn_model = joblib.load(MODEL_KNN)
        knn_vect  = joblib.load(VECT_KNN)
    else:
        knn_model = None

    if os.path.exists(METADATA):
        df_meta = pd.read_pickle(METADATA)
    else:
        df_meta = pd.read_csv(DATA_DIR + "wines_db_full.csv", on_bad_lines='skip', low_memory=False)

    if os.path.exists(GROUPS_FILE):
        KEYWORD_GROUPS = joblib.load(GROUPS_FILE)
        ORDERED_COLUMNS = joblib.load(COLUMNS_FILE)
    else:
        print("‚ùå ERREUR Config : Lancez 1_prepare.py")
        exit(1)

    variety_map = {}
    if os.path.exists(COLORS_FILE):
        with open(COLORS_FILE, "r") as f:
            variety_map = json.load(f)

except Exception as e:
    print(f"‚ùå Erreur Init : {e}")
    exit(1)

print(f"üöÄ Syst√®me pr√™t en {time.time() - t_init:.2f} s.\n")


# =============================================================================
# 2. OUTILS
# =============================================================================
def text_to_dataframe(user_text):
    vector = np.zeros((1, len(ORDERED_COLUMNS)), dtype=int)
    if user_text:
        user_text = user_text.lower()
        for i, col_name in enumerate(ORDERED_COLUMNS):
            synonyms = KEYWORD_GROUPS.get(col_name, [])
            for word in synonyms:
                if word in user_text:
                    vector[0, i] = 1
                    break 
    return pd.DataFrame(vector, columns=ORDERED_COLUMNS)
# =============================================================================
# 3. PR√âDICTION HYBRIDE (Correction Extension .data)
# =============================================================================

4. TESTS
# =============================================================================
tests = [
    ("Poulet", "chicken white citrus butter", "white"),
    ("Steak", "steak grilled pepper smoke", "red"),
    ("Dessert", "cake marzipan honey", "white"),
]

print("=== D√âBUT DES TESTS (MODE FICHIER TEMP) ===")
print(f"{'TEST':<10} | {'TEMPS':<8} | {'D√âCISION IA':<20} | {'R√âSULTAT FINAL'}")
print("-" * 100)

for nom, desc, color in tests:
    decision, bouteille, duree = fast_predict(desc, color)

    if bouteille is not None:
        res = f"{bouteille['title'][:30]}..."
    else:
        res = "Aucun vin (Conflit ou Pas de r√©sultat)"

    print(f"{nom:<10} | {duree:.4f}s  | {str(decision):<20} | {res}")

print("-" * 100)
